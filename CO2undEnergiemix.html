<!DOCTYPE html>
<html>
    <head>

        <title>CO2-Ausstoß und Energiemix auf Länderbene</title>

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="icon" href="data:;base64,iVBORw0KGgo=">
        
        <link rel="stylesheet" href="css/leaflet.css"/>
        <script src="js/leaflet.js" crossorigin=""></script>
        <script src="js/jquery-3.6.4.min.js" crossorigin=""></script>
        
        <script src="js/chroma.js" crossorigin=""></script>

        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
        
        <style>
            .container {
                display: flex;
                justify-content: center;
                align-items: center;
                flex-direction: column;
                height: 100vh; /* 100% of the viewport height */
                max-width: 800px; /* set maximum width like the map */
                margin: auto; /* center the container */
            }

            #mapid {
                width: 1000px;
                height: 600px;
            }
            .title {
                text-align: center;
                font-size: 2em;
                font-weight: bold;
                margin-bottom: 20px;
            }
            .slider {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin: auto;
                width: 100%; /* set the width to 70% */
            }
            .slider span {
                margin: 0 10px;
            }
			.info { 
                padding: 6px 8px; 
                font: 14px/16px Arial, Helvetica, sans-serif; 
                background: white; 
                background: rgba(255,255,255,0.8); 
                box-shadow: 0 0 15px rgba(0,0,0,0.2); 
                border-radius: 5px; 
            } 
            .info h4 { 
                margin: 0 0 5px; 
                color: #777; 
            }
            .legend { 
                text-align: left; 
                line-height: 18px; 
                color: #555; 
            }
            .legend i { 
                width: 18px;
                height: 18px; 
                float: left; 
                margin-right: 8px;
                opacity: 0.7; 
            }	
        </style>
        
    </head>
    
    
    <body>
        <div class="container">
            <h1 class="title">CO2-Ausstoß und Energiemix auf Länderbene</h1>
            <h2 id="yearDisplay">2021</h2>
            <div id="mapid"></div>
            <div class="slider">
                <span id="minYearCo2">${minYearCo2}</span>
                <input type="range" min="${minYearCo2}" max="${maxYearCo2}" value="${minYearCo2}" class="slider" id="yearSlider">
                <span id="maxYearCo2">${maxYearCo2}</span>
            </div>
            <div id="controls">
                <button id="addCountryButton">Land hinzufügen</button>
            </div>
            <div id="chart_div" style="width: 900px; height: 500px;"></div>
        </div>
        
    <script>
        
			googleSat = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                maxZoom: 20,
                subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
                attribution: "<a href=\'http://maps.google.com/\'>Google</a> Maps Satellite",
                noWrap: true
            });

            googleStreets = L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
                maxZoom: 20,
                subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
                attribution: "<a href=\'http://maps.google.com/\'>Google</a> Maps",
                noWrap: true
            });

       
            osmMapnik = new L.tileLayer(
                    'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                    {
                        maxZoom: 20,
                        attribution: 'Map data © OpenStreetMap contributors'
                    }
			);
					 
					
			/*osmMapnikbw = new L.tileLayer(
					'http://{s}.www.toolserver.org/tiles/bw-mapnik/{z}/{x}/{y}.png',
					{
						maxZoom: 20,
						attribution: 'Map data © OpenStreetMap contributors'
					}
            );*/
        
            var map = L.map('mapid', {
                center: [0, 0],
                zoom: 2,
                layers: [osmMapnik, googleStreets, osmMapnik]
            });

            var legend = L.control({position: 'bottomright'});

            google.charts.load('current', {'packages':['corechart']});

            document.getElementById('yearSlider').addEventListener('input', function(e) {
                selectedYear = parseInt(e.target.value);

                // Aktualisiere die Anzeige des Jahres
                document.getElementById('yearDisplay').textContent = selectedYear;

                // Aktualisiere die Karte für das ausgewählte Jahr
                co2EmissionsLayer.setStyle(totalCo2Style);
                co2EmissionsLayer.eachLayer(function (layer) {
                    onEachFeature(layer.feature, layer);
                });
            });

            // Button-Handler
            document.getElementById("addCountryButton").addEventListener("click", function() {
                // Wechseln Sie in den "Land hinzufügen"-Modus
                addCountryMode = true;
            });

            var addCountryMode = false;

		
            var co2Emissions = 0;
            var maxCo2 = 0;
            var minYearCo2 = Number.MAX_SAFE_INTEGER;
            var maxYearCo2 = 2021;

            let selectedYear = maxYearCo2;

            // Konfigurierbar: Maximalwert für co2Emissions und co2EmissionsPerCapita, der für die Generierung der Choropletenkarte und Legende berücksichtigt wird
            // Damit können Extremwerte abgeschwächt werden
            var maxCo2Allowed = 0;

            var numb_classes = 10;

            var classwidth_between_fac = 1/numb_classes;

            var grades_arr_co2 = [0, 20e6, 50e6, 100e6, 200e6, 500e6, 1e9, 2e9, 5e9, 10e9, Number.MAX_SAFE_INTEGER];
			
            colorRamp = chroma.scale('OrRd').classes(grades_arr_co2.length); //Farbstufenanzhal aus numb_classes
			//colorRamp = chroma.scale('OrRd'); //alternativ: stufenlose Variante
			
            var co2EmissionsLayer = new L.GeoJSON(null, {onEachFeature: onEachFeature});
            var co2EmissionsPerCapitaLayer = new L.GeoJSON(null, {onEachFeature: onEachFeature});
            var co2EmissionsLayer = new L.GeoJSON(null, {onEachFeature: onEachFeature});
            var co2EmissionsLayer = new L.GeoJSON(null, {onEachFeature: onEachFeature});

            $.ajax({
                url: 'http://10.152.57.134:8080/geoserver/heidemann/ows',
                data: {
                    version: '1.0.0',
                    request: 'GetFeature',
                    service: 'WFS',
                    typeName: 'heidemann:world_co2_emissions',
                    maxFeatures: '2000',
                    outputFormat: 'application/json'
                },
                dataType: 'json',
                jsonpCallback: 'getJson',
                success: handleJson
             });


             // Behandle die JSON-Daten
            function handleJson(data) {
                co2EmissionsLayer.addData(data);
                maxCo2 = 0;
                for (var feature of data.features) {
                    if (feature.properties && feature.properties.mannual_co2 && feature.properties.minyear) {
                        if (feature.properties.mannual_co2 > maxCo2) {
                            maxCo2 = feature.properties.mannual_co2;
                        }
                        if (feature.properties.minyear != 0 && (feature.properties.minyear< minYearCo2)) {
                            minYearCo2 = feature.properties.minyear;
                        }
                        if (feature.properties.name_de === "Australien") {
                            var year_arr = JSON.parse(feature.properties.year);
                            year_arr.sort(function(a, b){return a-b}); // Aufsteigende Sortierung
                            feature.properties.year = JSON.stringify(year_arr);
                        }
                    }
                }
                document.getElementById('minYearCo2').textContent = minYearCo2;
                document.getElementById('maxYearCo2').textContent = maxYearCo2;
                document.getElementById('yearSlider').min = minYearCo2;
                document.getElementById('yearSlider').max = maxYearCo2;
                document.getElementById('yearSlider').value = maxYearCo2;
                co2EmissionsLayer.setStyle(totalCo2Style);
                legend.addTo(map);
            }

            // Erhalte die Farbe basierend auf den CO2-Daten
            function getCo2Color(co2Value) {
                for (var i = 0; i < grades_arr_co2.length; i++) {
                    if (co2Value <= grades_arr_co2[i]) {
                        return colorRamp(i / (grades_arr_co2.length - 1)).hex();
                    }
                }
            }


            function totalCo2Style(feature) {
                if (feature.properties && feature.properties.year && feature.properties.annual_co2) {
                    var year_arr = JSON.parse(feature.properties.year);
                    var yearIndex = year_arr.indexOf(selectedYear);
                    if (yearIndex > -1) {
                        annual_co2_arr = JSON.parse(feature.properties.annual_co2);
                        var co2DataForYear = annual_co2_arr[yearIndex];

                        if (co2DataForYear !== null) {
                            return {
                                fillColor: getCo2Color(co2DataForYear),
                                weight: 2,
                                opacity: 1,
                                color: 'white',
                                dashArray: '3',
                                fillOpacity: 0.7
                            };
                        }
                    }
                }
                return {
                    fillColor: "gray",
                    weight: 2,
                    opacity: 1,
                    color: 'white',
                    dashArray: '3',
                    fillOpacity: 0.5
                };
            }

            var dataMatrix = [];

            function addCountryToChart(feature, layer) {
                var year_arr = JSON.parse(feature.properties.year).map(Number);
                var annual_co2_arr = JSON.parse(feature.properties.annual_co2);
                var countryName = feature.properties.name_de;

                dataMatrix[0].push(countryName);

                var index = 0;
                for(var i = 1; i < dataMatrix.length; i++) {
                    if (index < year_arr.length && dataMatrix[i][0] === year_arr[index]) {
                        dataMatrix[i].push(annual_co2_arr[index]);
                        index++;
                    } else {
                        dataMatrix[i].push(null);
                    }
                }
                drawChart(dataMatrix);
            }


            function drawChartForCountry(feature, layer) {
                var year_arr = JSON.parse(feature.properties.year).map(Number);
                var annual_co2_arr = JSON.parse(feature.properties.annual_co2);
                var countryName = feature.properties.name_de;

                // Create initial dataMatrix with all years and null emissions
                dataMatrix = [];
                for (var i = minYearCo2; i <= maxYearCo2; i++) {
                    dataMatrix.push([i, null]);
                }
                
                dataMatrix.unshift(['Jahr', countryName]); // Add column headers

                // Fill in actual data
                for(var i = 0; i < year_arr.length; i++) {
                    dataMatrix[year_arr[i] - minYearCo2 + 1][1] = annual_co2_arr[i];
                }

                drawChart(dataMatrix);
            }
			
            function onEachFeature(feature, layer) {
                if (feature.properties && feature.properties.year && feature.properties.annual_co2) {
                    layer.on('click', function (e) {
                        if (addCountryMode) {
                            addCountryToChart(feature, layer);
                        } else {
                            drawChartForCountry(feature, layer);
                        }
                    });
                    var year_arr = JSON.parse(feature.properties.year);
                    var annual_co2_arr = JSON.parse(feature.properties.annual_co2);

                    var yearIndex = year_arr.indexOf(selectedYear);
                    if (yearIndex > -1) {
                        var co2DataForYear = annual_co2_arr[yearIndex];
                        layer.bindPopup('<pre>CO2 Emissionen für ' + selectedYear + ': ' + co2DataForYear/1000000 + ' Mio. t </pre>');
                    } else {
                        layer.bindPopup('<pre>' + JSON.stringify(feature.properties, null, ' ').replace(/[\{\}"]/g, '') + '</pre>');
                    }
                } else {
                    layer.bindPopup('<pre>' + JSON.stringify(feature.properties, null, ' ').replace(/[\{\}"]/g, '') + '</pre>');
                }
            }
			
			///Methodenaufruf zur Integration des GeoJSON Layers in das L-Mapobjekt
            map.addLayer(co2EmissionsLayer);
            
            // Defintion der Layer controls////////////////////////////////////
            var baseMaps = {
                "Google Satellit": googleSat,
                "Google Streets": googleStreets,
				"OSM Map": osmMapnik,  
				// "osmMapnikbw": osmMapnikbw      
            };

            var overlayMaps = {
                "CO2 Emissionen": co2EmissionsLayer, 
                "CO2 Emissionen Pro Kopf" : co2EmissionsPerCapitaLayer
            };

            L.control.layers(baseMaps, overlayMaps).addTo(map);

            legend.onAdd = function (map) {
                var div = L.DomUtil.create('div', 'info legend');

                // Beginnen Sie mit dem "Keine Daten"-Eintrag
                div.innerHTML += '<i style="background:gray"></i> Keine Daten<br>';

                for (var i = 0; i < grades_arr_co2.length - 1; i++) {
                    var from = grades_arr_co2[i];
                    var to = grades_arr_co2[i + 1];

                    // Formatieren Sie die Werte für die Anzeige
                    var fromFormatted = from >= 1e9 ? (from / 1e9) + 'Gt' : from >= 1e6 ? (from / 1e6) + 'Mt' : from;
                    var toFormatted = to >= 1e9 ? (to / 1e9) + 'Gt' : to >= 1e6 ? (to / 1e6) + 'Mt' : to;

                    div.innerHTML +=
                        '<i style="background:' + getCo2Color(from + 1) + '"></i> ' +
                        fromFormatted + (i < grades_arr_co2.length - 2 ? '&ndash;' + toFormatted + '<br>' : '+');
                }

                return div;
            };

            function getCo2ColorForLegend(proportion) {
                return colorRamp(proportion).hex();
            }

            function drawChart(dataMatrix) {
                var data = google.visualization.arrayToDataTable(dataMatrix);

                var options = {
                    title: 'CO2 Emissionen',
                    curveType: 'function',
                    legend: { position: 'bottom' },
                    hAxis: {
                        title: 'Jahr',
                        format: '0'
                    },
                    vAxis: {
                        title: 'Emissionen',
                        viewWindow: { min: 0 },
                        format: 'short'
                    }
                };

                var chart = new google.visualization.LineChart(document.getElementById('chart_div'));

                // Apply formatter to all data columns
                var formatter = new google.visualization.NumberFormat({
                    pattern: '#,##0.00',
                    fractionDigits: 0
                });
                for (var i = 1; i < data.getNumberOfColumns(); i++) {
                    formatter.format(data, i);
                }

                google.visualization.events.addListener(chart, 'ready', function () {
                    var labels = chart.getContainer().getElementsByTagName('text');
                    Array.prototype.forEach.call(labels, function(label) {
                        if (label.textContent.indexOf('K') > -1) {
                            label.textContent = label.textContent.replace('K', 'Tsd');
                        }
                        if (label.textContent.indexOf('M') > -1) {
                            label.textContent = label.textContent.replace('M', 'Mio');
                        }
                        if (label.textContent.indexOf('B') > -1) {
                            label.textContent = label.textContent.replace('B', 'Mrd');
                        }
                    });
                });

                chart.draw(data, options);
            }
		
        
    </script>    
   
    </body>
</html>